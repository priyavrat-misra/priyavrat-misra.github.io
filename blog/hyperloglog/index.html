<!doctype html><html lang=en><head><title>Counting at Scale</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Priyavrat Misra"><meta name=description content="A mathematical exploration of efficiently counting at scale, where traditional methods fall short."><meta name=color-scheme content="light dark"><link rel=canonical href=https://priyavr.at/blog/hyperloglog/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=preload as=image href=/avatar/120x120.webp imagesrcset="/avatar/120x120.webp 1x, /avatar/180x180.webp 2x"><link rel=stylesheet href="/css/theme.min.0a2ba5f478b5f175a6dcb507cedd5d11eb9c893b3f78a547445cf1246218aae9.css" integrity="sha256-Ciul9Hi18XWm3LUHzt1dEeuciTs/eKVHRFzxJGIYquk="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css integrity=sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js integrity=sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1})})</script><meta property="og:title" content="Counting at Scale"><meta property="og:description" content="A mathematical exploration of efficiently counting at scale, where traditional methods fall short."><meta property="og:type" content="article"><meta property="og:url" content="https://priyavr.at/blog/hyperloglog/"><meta property="og:site_name" content="Priyavrat Misra"><meta property="og:image" content="https://priyavr.at/hyperloglog/hllBuckets.svg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Counting at Scale","image":"https:\/\/priyavr.at\/hyperloglog\/hllBuckets.svg","datePublished":"2025-07-03T20:48:00\u002b05:30","dateModified":"2026-01-06T20:44:52\u002b05:30","author":{"@type":"Person","name":"Priyavrat Misra","url":"https:\/\/priyavr.at\/"},"description":"A mathematical exploration of efficiently counting at scale, where traditional methods fall short."}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/priyavr.at\/"},{"@type":"ListItem","position":2,"name":"Blog","item":"https:\/\/priyavr.at\/blog\/"},{"@type":"ListItem","position":3,"name":"Counting at Scale","item":"https:\/\/priyavr.at\/blog\/hyperloglog\/"}]}</script></head><body><div id=content class=mx-auto><header class="container mt-4"><div class=row><div class="col-sm-4 col-12 text-sm-end text-center pt-sm-4"><a href=/ class=text-decoration-none><img id=avatar height=120 width=120 alt="Profile Picture" loading=eager fetchpriority=high src=/avatar/120x120.webp srcset="/avatar/120x120.webp 1x, /avatar/180x180.webp 2x"></a></div><div class="col-sm-8 col-12 text-sm-start text-center"><hgroup><h1 class="mb-2 mt-4"><a href=/ class=text-decoration-none>Priyavrat Misra</a></h1><p class="muted-text subtitle" aria-hidden=true></p><p class=sr-only>['Software Engineer', 'Computer Science Graduate', 'Open Source Advocate', 'Cycling Enthusiast']</p></hgroup><nav aria-label=Socials><ul class=list-inline><li class=list-inline-item><a href=https://www.linkedin.com/in/priyavrat-misra/ title=LinkedIn target=_blank class=text-muted rel="me noopener noreferrer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li class=list-inline-item><a href=https://github.com/priyavrat-misra title=GitHub target=_blank class=text-muted rel="me noopener noreferrer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class=list-inline-item><a href=https://www.strava.com/athletes/priyavrat title=Strava target=_blank class=text-muted rel="me noopener noreferrer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></a></li><li class=list-inline-item><a href=mailto:misra.priyavrat@gmail.com title=Email target=_blank class=text-muted><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li class=list-inline-item><a href=/blog/rss.xml title="RSS Feed" target=_blank class=text-muted><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav><nav aria-label=Menu><ul class=list-inline><li class=list-inline-item><strong><a href=/blog/ title="Ramblings for the curious mind.">Blog</a></strong></li><li class=list-inline-item><strong><a href=/tags/ title=Tags>Tags</a></strong></li><li class=list-inline-item><strong><a href=/resume/ title=Résumé>Résumé</a></strong></li></ul></nav></div></div><div class=theme-toggle-container><input id=dark class=sr-only type=checkbox role=switch aria-label="Switch between light and dark theme.">
<label id=theme-toggle title="Toggle theme" for=dark aria-hidden=true><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></label></div><hr></header><main class=container><header class=mb-3><hgroup id=blog-heading><h1>Counting at Scale</h1><p><small class=muted-text>Published: <time>03 Jul 25 15:18 UTC</time></small>
<small class=muted-text>Last updated: <time>06 Jan 26 15:14 UTC</time></small></p></hgroup><ul id=tags class=list-inline><li class=list-inline-item><a href=/tags/ title="View all tags"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></a></li><li class=list-inline-item><code><a href=/tags/databases>databases</a></code></li><li class=list-inline-item><code><a href=/tags/system-design>system-design</a></code></li><li class=list-inline-item><code><a href=/tags/mathematics>mathematics</a></code></li></ul><details id=toc-details><summary><strong>Table of Contents</strong></summary><nav id=TableOfContents><ul><li><a href=#motivation>Motivation</a></li><li><a href=#the-problem>The Problem</a></li><li><a href=#data-streams-vs-accumulated-data>Data Streams vs. Accumulated Data</a></li><li><a href=#practical-approaches-and-their-pitfalls>Practical Approaches and their Pitfalls</a></li><li><a href=#enter-hyperloglog-a-probabilistic-solution>Enter HyperLogLog: A Probabilistic Solution</a><ul><li><a href=#how-hyperloglog-works>How HyperLogLog works?</a></li><li><a href=#bucketing-and-mergeability>Bucketing and Mergeability</a></li><li><a href=#why-not-just-use-the-mean>Why not just use the mean?</a></li></ul></li><li><a href=#real-world-impact>Real-World Impact</a></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#further-reading>Further Reading</a></li></ul></li></ul></nav></details></header><article><h2 id=motivation>Motivation</h2><p>Last weekend, I decided to delve deeper into the world of databases and stumbled upon the fantastic <a href=https://15445.courses.cs.cmu.edu/ target=_blank rel="noopener noreferrer">CMU 15-445/645</a> course. After the introduction lecture, I jumped straight into the assignments. The first one, aptly named <a href=https://15445.courses.cs.cmu.edu/fall2024/project0/ target=_blank rel="noopener noreferrer">C++ Primer</a>, is a straightforward programming task designed to assess your grasp of basic C++ features.</p><h2 id=the-problem>The Problem</h2><p>The specific challenge is tracking the number of <strong>unique</strong> users accessing a website in a single day. If this were a standard algorithmic challenge, it would be a breeze. You could simply toss all the users into an <code>unordered_set</code> and return its size. While this sounds easy, real-world problems are rarely so simple or memory-friendly.</p><p>Let’s break down this standard approach. Imagine we are working at Facebook. Approximately one billion unique users log in daily, and each user ID is around 8 bytes. Using an <code>unordered_set</code>, that requires 8 billion bytes of memory. That is about 7.7 GB just to count users! All we really want is a single number. It is like renting an entire stadium just to host a two-person meeting.</p><h2 id=data-streams-vs-accumulated-data>Data Streams vs. Accumulated Data</h2><p>There is another subtlety here. In real-world systems, we often deal with a data stream rather than a static, accumulated dataset. Users are constantly logging in, and we want to process each event as it happens, potentially across distributed servers, without storing the entire history of who has logged in so far.</p><p>The <code>unordered_set</code> solution works if we have all the data in memory and can afford to keep it there, but that is rarely feasible at scale. In practice, we cannot keep every user ID we have ever seen, especially when the list is massive and ever-growing. Instead, we need a way to estimate the number of unique users “on the fly” using minimal memory and without revisiting or accumulating all previous data.</p><h2 id=practical-approaches-and-their-pitfalls>Practical Approaches and their Pitfalls</h2><p>Let’s get practical. Suppose there is a “last seen” metadata field associated with each user. We could increment a counter whenever “last seen” is updated from a timestamp that is not from the current day. This seems like something that could be achieved with database triggers, but it will add extra overhead to the database. Furthermore, we are assuming the existence of a “last seen” field, which is not always available.</p><p>Now, consider a different question: “How many unique users have liked posts in the last month?” Here, we’re dealing with a different set of actions and data. Often, we have no choice but to perform full table scans, which can put serious strain on the database.</p><h2 id=enter-hyperloglog-a-probabilistic-solution>Enter HyperLogLog: A Probabilistic Solution</h2><p>The problem statement brings us to HyperLogLog, a probabilistic algorithm designed to estimate the number of unique elements (the “cardinality”) in a data stream without explicitly storing every item. The key idea is that the more unique elements we see, the more likely we are to encounter a hash with many contiguous zeroes.</p><blockquote><p>According to <a href=https://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf target=_blank rel="noopener noreferrer">HyperLogLog: The analysis of a near-optimal cardinality estimation algorithm</a>, the HyperLogLog algorithm is able to estimate cardinalities of \(>10^{9}\) with a typical accuracy (standard error) of \(2\%\), using \(1.5 kB\) of memory.</p></blockquote><h3 id=how-hyperloglog-works>How HyperLogLog works?</h3><p>HyperLogLog uses a hash function. Ideally, this function produces uniformly distributed values. We take the user ID (or any suitable identifier), hash it to a numerical value, and use its binary representation. Some implementations consider the maximum number of trailing zeroes, while others look at the maximum leftmost position of \(1\) (the number of leading zeroes plus one). For our discussion, we will stick with the latter as it matches the problem statement.</p><p>Assuming no hash collisions, our problem reduces to finding the number of unique binary strings. If you remember your high school math, for a random binary string, the probability of getting \(k\) leading zeroes followed by a one is \(1 / 2^{k+1}\).</p><figure><img src=/hyperloglog/leftmostOneProbability.svg alt="Probability of getting a leftmost one illustrated" loading=lazy></figure><p>Alternatively, think of the string as a series of coin tosses: zero means heads, one means tails. If, across multiple individual runs, the longest run of heads we encountered is \(l\), then its probability is \(1 / 2^{l+1}\). In other words, we can estimate that, on average, we’ve tried at least \(2^{l+1}\) times.</p><p>To put it simply: if we see a maximum run of \(2\) heads, \(HHT\), we probably tossed the coin at least \(2^{2+1} = 8\) times, \(\{HHH, HHT, HTH, HTT,\allowbreak THH, THT, TTH, TTT\}\). The probability ends up being \(1 / 8\). Note that, \(HHH\) isn&rsquo;t valid here because we considered the maximum leading heads to be \(2\), so technically it should be one less, but to keep things simple, we can round it off. Relating this back to our user count example, if we encounter a user ID with a hash code where the leftmost one is at position \(5\), this implies we have seen approximately \(2^5\) users.</p><p>Try to solve for a maximum run of 10 heads. Notice how quickly the probability drops!</p><p>The chance of seeing a hash with many leading zeroes is very low. The more unique elements we see, the higher the chance we will encounter such a hash. However, it is still possible to get unlucky and see a binary string with many leading zeroes after just a few tries, thanks to uniform hashing. These are outliers, and HyperLogLog has a clever way of handling them.</p><h3 id=bucketing-and-mergeability>Bucketing and Mergeability</h3><p>To manage outliers, HyperLogLog distributes the hash values into different buckets based on the initial \(b\) bits of the hash. This gives us a total of \(2^b\) buckets, and each bucket tracks its own maximum. Even though we are distributing values, the maximum among them remains the same. This means our problem is <em>mergeable</em>, so we do not have to worry about double-counting.</p><figure><img src=/hyperloglog/hllBuckets.svg alt="Bucketing in HyperLogLog illustrated" loading=lazy></figure><p>This property is incredibly useful for queries such as “How many unique users have liked posts in the last month?” We can easily combine the buckets for each day and calculate the result. To do this, we persist each day’s serialized HyperLogLog structure. Since this structure is typically just a few kilobytes, storage is not an issue. The mergeability of HyperLogLog is also a boon in distributed systems: each server can maintain its own buckets, which can later be aggregated.</p><h3 id=why-not-just-use-the-mean>Why not just use the mean?</h3><p>So, what if we take the average of all the maximums across the buckets? Does it solve the outlier problem? Unfortunately, no. The average is still affected by outliers. Instead, HyperLogLog uses the <em>harmonic mean</em>, which is less sensitive to large outliers.</p><p>Let \(b\) be the number of bits chosen to identify a bucket, giving us \(m = 2^b\) buckets. Let \(p_i\) be the maximum leftmost position of \(1\) seen so far for bucket \(i\). The cardinality estimate is calculated as:</p>\[0.79402 * m * \frac{m}{\sum_{i=0}^{m-1} 2^{-p_i}}\]<p>Notice that outliers appear in the denominator as \(p_i\), contributing only slightly to the cardinality. Also, the more buckets we have, the more outliers we can handle, and the more accurate the cardinality estimate becomes (although this does require more memory).</p><h2 id=real-world-impact>Real-World Impact</h2><p>The efficiency and scalability of HyperLogLog have cemented its place as an industry standard for large-scale unique counting. For instance, Redis offers built-in HyperLogLog support, enabling developers to track unique website visitors or event occurrences with just a few kilobytes of memory. Likewise, Google Analytics relies on similar probabilistic algorithms to deliver fast, accurate unique user counts across billions of events, powering real-time analytics on a global scale. Beyond these high-profile examples, HyperLogLog is widely used in streaming analytics dashboards, traffic heatmaps, and any scenario where massive data volumes demand both accuracy and minimal memory usage.</p><h2 id=conclusion>Conclusion</h2><p>I hope you found this exploration as engaging to read as I did to put together! Thanks for joining me on this deep dive.</p><h3 id=further-reading>Further Reading</h3><ul><li><a href=https://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf target=_blank rel="noopener noreferrer">Original HyperLogLog Paper (PDF)</a></li><li><a href=https://engineering.fb.com/2018/12/13/data-infrastructure/hyperloglog/ target=_blank rel="noopener noreferrer">A blog on Meta's implementation of HLL</a></li><li><a href=https://redis.io/docs/latest/develop/data-types/probabilistic/hyperloglogs/ target=_blank rel="noopener noreferrer">HyperLogLog in Redis</a></li><li><a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/approximate_aggregate_functions#approx_count_distinct target=_blank rel="noopener noreferrer">BigQuery’s Approximate Count Distinct</a></li></ul></article><div id=email-subscription><form id=subscription-form action=# method=POST aria-label="RSS/Email Subscription"><p>Stay updated with the latest posts via <a href=/blog/rss.xml target=_blank title="Subscribe via RSS">RSS</a> or email.</p><div class=form-group><label for=email-input class=sr-only>Email Address</label>
<input type=email id=email-input name=email placeholder=email@example.com required aria-required=true>
<button type=submit>Subscribe</button></div><small id=form-status aria-live=polite class=status-message></small><noscript>JavaScript is required to subscribe via email. Please enable JavaScript or use the <a href=/blog/rss.xml>RSS feed</a>.</noscript></form></div><script src=/js/subscribe.min.5e6ecb7c9f47963784f3f4e851f952402a21148ff4b997d770372c0f2ba3309b.js defer integrity="sha256-Xm7LfJ9HljeE8/ToUflSQCohFI/0uZfXcDcsDyujMJs="></script><a href=# id=back-to-top data-tooltip="Scroll to top" aria-label="scroll back to top"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="16 12 12 8 8 12"/><line x1="12" y1="16" x2="12" y2="8"/></svg></a><hr><div id=giscus-comments-container></div><script>let isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches;const giscusScript=document.createElement("script");giscusScript.src="https://giscus.app/client.js",giscusScript.setAttribute("data-repo","priyavrat-misra/personal-website"),giscusScript.setAttribute("data-repo-id","R_kgDOHXZkKg"),giscusScript.setAttribute("data-category","Announcements"),giscusScript.setAttribute("data-category-id","DIC_kwDOHXZkKs4Ccjrk"),giscusScript.setAttribute("data-mapping","pathname"),giscusScript.setAttribute("data-strict","0"),giscusScript.setAttribute("data-reactions-enabled","1"),giscusScript.setAttribute("data-emit-metadata","0"),giscusScript.setAttribute("data-input-position","top"),giscusScript.setAttribute("data-theme",isDarkMode?"dark_dimmed":"light"),giscusScript.setAttribute("data-lang","en"),giscusScript.setAttribute("data-loading","lazy"),giscusScript.setAttribute("crossorigin","anonymous"),giscusScript.async=!0,document.getElementById("giscus-comments-container").appendChild(giscusScript),document.getElementById("dark")?.addEventListener("change",()=>{isDarkMode=!isDarkMode;const e=document.querySelector("iframe.giscus-frame");e?.contentWindow.postMessage({giscus:{setConfig:{theme:isDarkMode?"dark_dimmed":"light"}}},e.src)})</script><noscript>Please enable JavaScript to view the comments powered by Giscus.</noscript></main><footer><p><small class=muted-text>&copy; 2022-2026 Priyavrat Misra.<br><em>This site is built on fundamentals and handcrafted for <abbr title=accessibility>a11y</abbr>.</em></small></p></footer></div></body></html>